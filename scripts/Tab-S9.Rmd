---
title: "Tab. S9: Spearman's rank correlation between sequencing depth and selected environmental predictors to assess seq depth bias."
author: "Jessica Finck"
date: "2025-11-30"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(123)
```

Data were chosen to not be rarefied. However, this can introduce a sequencing depth bias, if sequencing depths vary a lot between samples, which can impact statistical test results down the line. To check that no sequencing depth bias occurred in respect to the tested parameters, we applied Spearman rank correlations to verify that sequencing depth variations did not affect test results down the line.

### Pre-processing: Preparing the `phyloseq` objects from raw data

For this analysis we use `phyloseq` objects which we created from our ASV and taxa tables, and metadata.

First, we imported our data into R.

```{r import, tidy=TRUE, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
library(readxl) # import xlsx files
library(dplyr)  # data wrangling
library(ape)    # import nwk files

# bacteria
otu_bac <- read_excel("masterfile_bac.xlsx", sheet = "asv_table") %>% as.data.frame()
tax_bac <- read_excel("masterfile_bac.xlsx", sheet = "tax_table") %>% as.data.frame()
data_bac <- read_excel("masterfile_bac.xlsx", sheet = "metadata_all") %>% as.data.frame()
tree_bac <- ape::read.tree("tree_dada2_bac.nwk")

# fungi
otu_fun <- read_excel("masterfile_fun.xlsx", sheet = "asv_table") %>% as.data.frame()
tax_fun <- read_excel("masterfile_fun.xlsx", sheet = "tax_table") %>% as.data.frame()
data_fun <- read_excel("masterfile_fun.xlsx", sheet = "metadata_all") %>% as.data.frame()
tree_fun <- ape::read.tree("tree_dada2_fun.nwk")
```

Then, we formatted the variable classes.

```{r format, tidy=TRUE, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
# bacteria 
data_bac = data_bac %>% mutate(leg_num = leg)  
data_bac$leg_num = gsub('yes', '1', data_bac$leg_num)
data_bac$leg_num = gsub('no', '0', data_bac$leg_num)
data_bac$leg_num <- as.numeric(data_bac$leg_num)

data_bac = data_bac %>% mutate(gra_num = gra)  
data_bac$gra_num = gsub('yes', '1', data_bac$gra_num)
data_bac$gra_num = gsub('no', '0', data_bac$gra_num)
data_bac$gra_num <- as.numeric(data_bac$gra_num)

data_bac = data_bac %>% mutate(monocult_num = monocult)  
data_bac$monocult_num = gsub('yes', '1', data_bac$monocult_num)
data_bac$monocult_num = gsub('no', '0', data_bac$monocult_num)
data_bac$monocult_num <- as.numeric(data_bac$monocult_num)

data_bac = data_bac %>% mutate(plot_num = plot) 
data_bac$plot_num <- as.numeric(data_bac$plot_num)

data_bac$psr <- as.numeric(data_bac$psr)
data_bac$div_level <- as.factor(data_bac$div_level)
data_bac$plot <- as.factor(data_bac$plot)
data_bac$the <- as.factor(data_bac$the)
data_bac$she <- as.factor(data_bac$she)
data_bac$leg <- as.factor(data_bac$leg)
data_bac$gra <- as.factor(data_bac$gra)

# fungi
data_fun = data_fun %>% mutate(leg_num = leg)  
data_fun$leg_num = gsub('yes', '1', data_fun$leg_num)
data_fun$leg_num = gsub('no', '0', data_fun$leg_num)
data_fun$leg_num <- as.numeric(data_fun$leg_num)

data_fun = data_fun %>% mutate(gra_num = gra)  
data_fun$gra_num = gsub('yes', '1', data_fun$gra_num)
data_fun$gra_num = gsub('no', '0', data_fun$gra_num)
data_fun$gra_num <- as.numeric(data_fun$gra_num)

data_fun = data_fun %>% mutate(monocult_num = monocult)  
data_fun$monocult_num = gsub('yes', '1', data_fun$monocult_num)
data_fun$monocult_num = gsub('no', '0', data_fun$monocult_num)
data_fun$monocult_num <- as.numeric(data_fun$monocult_num)

data_fun = data_fun %>% mutate(plot_num = plot) 
data_fun$plot_num <- as.numeric(data_fun$plot_num)

data_fun$psr <- as.numeric(data_fun$psr)
data_fun$div_level <- as.factor(data_fun$div_level)
data_fun$plot <- as.factor(data_fun$plot)
data_fun$the <- as.factor(data_fun$the)
data_fun$she <- as.factor(data_fun$she)
data_fun$leg <- as.factor(data_fun$leg)
data_fun$gra <- as.factor(data_fun$gra)
```

Followed by adjusting the taxa names and defining the row names.

```{r names, tidy=TRUE, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
# bacteria
tax_bac$Kingdom = gsub("d__","",as.character(tax_bac$Kingdom))
tax_bac$Phylum = gsub("p__","",as.character(tax_bac$Phylum))
tax_bac$Class = gsub("c__","",as.character(tax_bac$Class))
tax_bac$Order = gsub("o__","",as.character(tax_bac$Order))
tax_bac$Family = gsub("f__","",as.character(tax_bac$Family))
tax_bac$Genus = gsub("g__","",as.character(tax_bac$Genus))
tax_bac$Species = gsub("s__","",as.character(tax_bac$Species))

otu_bac <- otu_bac %>% tibble::column_to_rownames("asv")
tax_bac <- tax_bac %>% tibble::column_to_rownames("asv")
data_bac <- data_bac %>% tibble::column_to_rownames("sID")

# fungi
tax_fun$Kingdom = gsub("k__","",as.character(tax_fun$Kingdom))
tax_fun$Phylum = gsub("p__","",as.character(tax_fun$Phylum))
tax_fun$Class = gsub("c__","",as.character(tax_fun$Class))
tax_fun$Order = gsub("o__","",as.character(tax_fun$Order))
tax_fun$Family = gsub("f__","",as.character(tax_fun$Family))
tax_fun$Genus = gsub("g__","",as.character(tax_fun$Genus))
tax_fun$Species = gsub("s__","",as.character(tax_fun$Species))

otu_fun <- otu_fun %>% tibble::column_to_rownames("asv")
tax_fun <- tax_fun %>% tibble::column_to_rownames("asv")
data_fun <- data_fun %>% tibble::column_to_rownames("sID")
```

And finally writing the `phyloseq` objects, and extracting the metadata from them.

```{r ps, tidy=TRUE, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
library(phyloseq)

# bacteria 
otu_bac <- as.matrix(otu_bac)
tax_bac <- as.matrix(tax_bac)

OTU_B = phyloseq::otu_table(otu_bac, taxa_are_rows = T)
TAX_B = phyloseq::tax_table(tax_bac)
samples_B = phyloseq::sample_data(data_bac)
ps.bac <- phyloseq::phyloseq(OTU_B, TAX_B, samples_B)
tree_B = phyloseq::phy_tree(tree_bac)
ps.bac <- phyloseq::phyloseq(OTU_B, TAX_B, samples_B, tree_B)

# fungi
otu_fun <- as.matrix(otu_fun)
tax_fun <- as.matrix(tax_fun)

OTU_F = phyloseq::otu_table(otu_fun, taxa_are_rows = T)
TAX_F = phyloseq::tax_table(tax_fun)
samples_F = phyloseq::sample_data(data_fun)
ps.fun <- phyloseq::phyloseq(OTU_F, TAX_F, samples_F)
tree_F = phyloseq::phy_tree(tree_fun)
ps.fun <- phyloseq::phyloseq(OTU_F, TAX_F, samples_F, tree_F)
```

After writing the phyloseq objects based on the raw counts, we then cleaned up the data using the `microeco` package (i.e., to tidy the taxonomy and filter out chloroplasts and non-bacterial, non-archaeal and non-fungal sequences).

```{r tidy, tidy=TRUE, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
library(microeco)
library(file2meco)

# convert to microeco (meco) object
meco.fun = phyloseq2meco(ps.fun)
meco.bac = phyloseq2meco(ps.bac)

# tidy taxonomy 
meco.bac$tax_table %>% 
  base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
meco.bac$filter_pollution(taxa = c("mitochondria", "chloroplast"))
meco.bac$tidy_dataset()                                                         

meco.fun$tax_table %>% 
  base::subset(Kingdom == "k__Fungi")
meco.fun$filter_pollution(taxa = c("mitochondria", "chloroplast"))
meco.fun$tidy_dataset()

# convert back to phyloseq (ps) object
ps.meco.bac = meco2phyloseq(meco.bac)
ps.meco.fun = meco2phyloseq(meco.fun)
```

### **1. Assess potential sequencing depth bias**

We are using the `phyloseq` package to calculate Spearman rank correlations.

**1.1 Extract seq depths and the parameters to test them against**

```{r extract, tidy=FALSE, message=FALSE, warning=FALSE, results='hide'}
depths.fun <- data.frame(sample = names(sample_sums(ps.meco.fun)), 
                     depth = sample_sums(ps.meco.fun),
                     PSR = sample_data(ps.meco.fun)$psr,
                     FG_richness = sample_data(ps.meco.fun)$fgr_sown,
                     Multifunc.1 = sample_data(ps.meco.fun)$grich_funt,
                     Multifunc.2 = sample_data(ps.meco.fun)$grich_fung,
                     lg_PSR = sample_data(ps.meco.fun)$lg_psr,
                     grasses = sample_data(ps.meco.fun)$gra_num,
                     legumes = sample_data(ps.meco.fun)$leg_num)

depths.bac <- data.frame(sample = names(sample_sums(ps.meco.bac)), 
                         depth = sample_sums(ps.meco.bac),
                         PSR = sample_data(ps.meco.bac)$psr,
                         FG_richness = sample_data(ps.meco.bac)$fgr_sown,
                         Multifunc = sample_data(ps.meco.bac)$pw_num_picrust,
                         lg_PSR = sample_data(ps.meco.bac)$lg_psr,
                         grasses = sample_data(ps.meco.bac)$gra_num,
                         legumes = sample_data(ps.meco.bac)$leg_num)
```

**1.2 Check if seq depth varies systematically across diversity (PSR) levels**

```{r check, tidy=TRUE, message=FALSE, warning=FALSE, results='hide'}
## Fungi
depths.fun %>% group_by(PSR) %>% summarize(min_depth = min(depth), max_depth = max(depth), median_depth = median(depth)) 
depths.fun %>% count()

## Bacteria
depths.bac %>% group_by(PSR) %>% summarize(min_depth = min(depth), max_depth = max(depth), median_depth = median(depth))
depths.bac %>% count()
```

**1.3 Check potential seq depth bias for each parameter using the `cor.test`** **function**

```{r check, tidy=TRUE, message=FALSE, warning=FALSE, results='hide'}
## ~ Fungi
cor.test(depths.fun$depth, depths.fun$PSR, method = "spearman")
cor.test(depths.fun$depth, depths.fun$lg_PSR, method = "spearman")
cor.test(depths.fun$depth, depths.fun$FG_richness, method = "spearman")

cor.test(depths.fun$depth, depths.fun$grasses, method = "spearman")
cor.test(depths.fun$depth, depths.fun$legumes, method = "spearman")

cor.test(depths.fun$depth, depths.fun$Multifunc.1, method = "spearman")
cor.test(depths.fun$depth, depths.fun$Multifunc.2, method = "spearman")

## ~ Bacteria
cor.test(depths.bac$depth, depths.bac$PSR, method = "spearman")
cor.test(depths.bac$depth, depths.bac$lg_PSR, method = "spearman")
cor.test(depths.bac$depth, depths.bac$FG_richness, method = "spearman")

cor.test(depths.bac$depth, depths.bac$grasses, method = "spearman")
cor.test(depths.bac$depth, depths.bac$legumes, method = "spearman")

cor.test(depths.bac$depth, depths.bac$Multifunc, method = "spearman")
```
