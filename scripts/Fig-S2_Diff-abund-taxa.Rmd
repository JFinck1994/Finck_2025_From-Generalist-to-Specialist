---
title: "Fig. S2: Plant community structure drives fungal community composition."
author: "Jessica Finck"
date: "2025-05-12"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script uses differential abundance testing to analyse the impact of our chosen parameters *(here: plant species richness PSR, presence of legumes and grasses)* on microbial ASVs to investigate whether they up or downregulate certain taxa, and to which extent.

### Pre-processing: Preparing the `phyloseq` objects from raw data

For this analysis we use `phyloseq` objects which we created from our ASV and taxa tables, and metadata.

First, we imported our data into R.

```{r import, tidy=TRUE, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
library(readxl) # import xlsx files
library(dplyr)  # data wrangling
library(ape)    # import nwk files

# bacteria
otu_bac <- read_excel("masterfile_bac.xlsx", sheet = "asv_table") %>% as.data.frame()
tax_bac <- read_excel("masterfile_bac.xlsx", sheet = "tax_table") %>% as.data.frame()
data_bac <- read_excel("masterfile_bac.xlsx", sheet = "metadata_all") %>% as.data.frame()
tree_bac <- ape::read.tree("tree_dada2_bac.nwk")

# fungi
otu_fun <- read_excel("masterfile_fun.xlsx", sheet = "asv_table") %>% as.data.frame()
tax_fun <- read_excel("masterfile_fun.xlsx", sheet = "tax_table") %>% as.data.frame()
data_fun <- read_excel("masterfile_fun.xlsx", sheet = "metadata_all") %>% as.data.frame()
tree_fun <- ape::read.tree("tree_dada2_fun.nwk")
```

Then, we formatted the variable classes.

```{r format, tidy=TRUE, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
# bacteria 
data_bac = data_bac %>% mutate(leg_num = leg)  
data_bac$leg_num = gsub('yes', '1', data_bac$leg_num)
data_bac$leg_num = gsub('no', '0', data_bac$leg_num)
data_bac$leg_num <- as.numeric(data_bac$leg_num)

data_bac = data_bac %>% mutate(gra_num = gra)  
data_bac$gra_num = gsub('yes', '1', data_bac$gra_num)
data_bac$gra_num = gsub('no', '0', data_bac$gra_num)
data_bac$gra_num <- as.numeric(data_bac$gra_num)

data_bac = data_bac %>% mutate(monocult_num = monocult)  
data_bac$monocult_num = gsub('yes', '1', data_bac$monocult_num)
data_bac$monocult_num = gsub('no', '0', data_bac$monocult_num)
data_bac$monocult_num <- as.numeric(data_bac$monocult_num)

data_bac = data_bac %>% mutate(plot_num = plot) 
data_bac$plot_num <- as.numeric(data_bac$plot_num)

data_bac$psr <- as.numeric(data_bac$psr)
data_bac$div_level <- as.factor(data_bac$div_level)
data_bac$plot <- as.factor(data_bac$plot)
data_bac$the <- as.factor(data_bac$the)
data_bac$she <- as.factor(data_bac$she)
data_bac$leg <- as.factor(data_bac$leg)
data_bac$gra <- as.factor(data_bac$gra)

# fungi
data_fun = data_fun %>% mutate(leg_num = leg)  
data_fun$leg_num = gsub('yes', '1', data_fun$leg_num)
data_fun$leg_num = gsub('no', '0', data_fun$leg_num)
data_fun$leg_num <- as.numeric(data_fun$leg_num)

data_fun = data_fun %>% mutate(gra_num = gra)  
data_fun$gra_num = gsub('yes', '1', data_fun$gra_num)
data_fun$gra_num = gsub('no', '0', data_fun$gra_num)
data_fun$gra_num <- as.numeric(data_fun$gra_num)

data_fun = data_fun %>% mutate(monocult_num = monocult)  
data_fun$monocult_num = gsub('yes', '1', data_fun$monocult_num)
data_fun$monocult_num = gsub('no', '0', data_fun$monocult_num)
data_fun$monocult_num <- as.numeric(data_fun$monocult_num)

data_fun = data_fun %>% mutate(plot_num = plot) 
data_fun$plot_num <- as.numeric(data_fun$plot_num)

data_fun$psr <- as.numeric(data_fun$psr)
data_fun$div_level <- as.factor(data_fun$div_level)
data_fun$plot <- as.factor(data_fun$plot)
data_fun$the <- as.factor(data_fun$the)
data_fun$she <- as.factor(data_fun$she)
data_fun$leg <- as.factor(data_fun$leg)
data_fun$gra <- as.factor(data_fun$gra)
```

Followed by adjusting the taxa names and defining the row names.

```{r names, tidy=TRUE, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
# bacteria
tax_bac$Kingdom = gsub("d__","",as.character(tax_bac$Kingdom))
tax_bac$Phylum = gsub("p__","",as.character(tax_bac$Phylum))
tax_bac$Class = gsub("c__","",as.character(tax_bac$Class))
tax_bac$Order = gsub("o__","",as.character(tax_bac$Order))
tax_bac$Family = gsub("f__","",as.character(tax_bac$Family))
tax_bac$Genus = gsub("g__","",as.character(tax_bac$Genus))
tax_bac$Species = gsub("s__","",as.character(tax_bac$Species))

otu_bac <- otu_bac %>% tibble::column_to_rownames("asv")
tax_bac <- tax_bac %>% tibble::column_to_rownames("asv")
data_bac <- data_bac %>% tibble::column_to_rownames("sID")

# fungi
tax_fun$Kingdom = gsub("k__","",as.character(tax_fun$Kingdom))
tax_fun$Phylum = gsub("p__","",as.character(tax_fun$Phylum))
tax_fun$Class = gsub("c__","",as.character(tax_fun$Class))
tax_fun$Order = gsub("o__","",as.character(tax_fun$Order))
tax_fun$Family = gsub("f__","",as.character(tax_fun$Family))
tax_fun$Genus = gsub("g__","",as.character(tax_fun$Genus))
tax_fun$Species = gsub("s__","",as.character(tax_fun$Species))

otu_fun <- otu_fun %>% tibble::column_to_rownames("asv")
tax_fun <- tax_fun %>% tibble::column_to_rownames("asv")
data_fun <- data_fun %>% tibble::column_to_rownames("sID")
```

And finally writing the `phyloseq` objects.

```{r ps, tidy=TRUE, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
library(phyloseq)

# bacteria 
otu_bac <- as.matrix(otu_bac)
tax_bac <- as.matrix(tax_bac)

OTU_B = phyloseq::otu_table(otu_bac, taxa_are_rows = T)
TAX_B = phyloseq::tax_table(tax_bac)
samples_B = phyloseq::sample_data(data_bac)
ps.bac <- phyloseq::phyloseq(OTU_B, TAX_B, samples_B)
tree_B = phyloseq::phy_tree(tree_bac)
ps.bac <- phyloseq::phyloseq(OTU_B, TAX_B, samples_B, tree_B)

# fungi
otu_fun <- as.matrix(otu_fun)
tax_fun <- as.matrix(tax_fun)

OTU_F = phyloseq::otu_table(otu_fun, taxa_are_rows = T)
TAX_F = phyloseq::tax_table(tax_fun)
samples_F = phyloseq::sample_data(data_fun)
ps.fun <- phyloseq::phyloseq(OTU_F, TAX_F, samples_F)
tree_F = phyloseq::phy_tree(tree_fun)
ps.fun <- phyloseq::phyloseq(OTU_F, TAX_F, samples_F, tree_F)
```

After writing the phyloseq objects based on the raw counts, we then cleaned up the data using the `microeco` package (i.e., to tidy the taxonomy and filter out chloroplasts and non-bacterial, non-archaeal and non-fungal sequences).

```{r tidy, tidy=TRUE, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
library(microeco)
library(file2meco)

# convert to microeco (meco) object
meco.fun = phyloseq2meco(ps.fun)
meco.bac = phyloseq2meco(ps.bac)

# tidy taxonomy 
meco.bac$tax_table %>% 
  base::subset(Kingdom == "k__Archaea" | Kingdom == "k__Bacteria")
meco.bac$filter_pollution(taxa = c("mitochondria", "chloroplast"))
meco.bac$tidy_dataset()                                                         

meco.fun$tax_table %>% 
  base::subset(Kingdom == "k__Fungi")
meco.fun$filter_pollution(taxa = c("mitochondria", "chloroplast"))
meco.fun$tidy_dataset()

# convert back to phyloseq (ps) object
ps.meco.bac = meco2phyloseq(meco.bac)
ps.meco.fun = meco2phyloseq(meco.fun)
```

Lastly, we TSS-transformed, and CLR-normalized the tidied `phyloseq` object to use for follow-up analyses:

```{r normalize, tidy=TRUE, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
library(microbiomeMarker) # TSS normalization
library(microbiome)       # CLR transformation
library(dplyr)            # data wrangling

ps.bac.tss = ps.meco.bac %>% microbiomeMarker::normalize(method = "TSS")
ps.fun.tss = ps.meco.fun %>% microbiomeMarker::normalize(method = "TSS")
ps.bac.norm = ps.meco.bac %>% microbiomeMarker::normalize(method = "TSS") %>% microbiome::transform('clr')
ps.fun.norm = ps.meco.fun %>% microbiomeMarker::normalize(method = "TSS") %>% microbiome::transform('clr')
```

### **1. Extract count data from `phyloseq`** objects

Differential abundance testing requires non-normalized and un-transformed data, as the underlying algorithm has been optimized to deal with raw counts, while also performing its own set of normalization (i.e., via DESeq2).

```{r prereq, tidy=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(phyloseq)
library(dplyr)

counts.bac = data.frame(otu_table(ps.meco.bac)) 
data.bac3 = data.frame(phyloseq::sample_data(ps.meco.bac))
taxa.bac = phyloseq::tax_table(ps.meco.bac) %>% as.data.frame()

counts.fun = data.frame(otu_table(ps.meco.fun))
data.fun3 = data.frame(phyloseq::sample_data(ps.meco.fun))
taxa.fun = phyloseq::tax_table(ps.meco.fun) %>% as.data.frame()
```

### 2. Prepare the data for DESeq2

DESeq2 has several pre-requisites which must be fulfilled including:

-   count data is matrix

-   sample order (count data) = sample order (metadata)

-   metadata & taxa table are dataframes

-   metadata contains **no factor class variables** (alas, convert to binary/numeric class)

```{r convert, tidy=FALSE, message=FALSE, warning=FALSE, results='hide', echo=FALSE}
## Convert factor colums to binary 0/1
data.bac3$gra1 = ifelse(data.bac3$gra == "yes", 1, 0)
data.bac3$leg1 = ifelse(data.bac3$leg == "yes", 1, 0)

data.fun3$gra1 = ifelse(data.fun3$gra == "yes", 1, 0)
data.fun3$leg1 = ifelse(data.fun3$leg == "yes", 1, 0)
```

### 3. Workflow for differential abundance testing with `DESeq2`

**3.1 Run the DESeq2 pipeline with the `DESeq2`** **package**

```{r deseq2, tidy=TRUE, message=FALSE, warning=FALSE, results='hide'}
library(DESeq2)

## PSR ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
dds_psr.bac <- DESeqDataSetFromMatrix(countData = counts.bac, colData = data.bac3, design = ~ div_level)
dds_psr.bac <- DESeq(dds_psr.bac)
res_psr.bac <- results(dds_psr.bac)

dds_psr.fun <- DESeqDataSetFromMatrix(countData = counts.fun, colData = data.fun3, design = ~ div_level)
dds_psr.fun <- DESeq(dds_psr.fun)
res_psr.fun <- results(dds_psr.fun)

## grasses ~~~~~~~~~~~~~~~~~~~~~~~~~~~
dds_gra.bac <- DESeqDataSetFromMatrix(countData = counts.bac, colData = data.bac3, design = ~ gra1)
dds_gra.bac <- DESeq(dds_gra.bac)
res_gra.bac <- results(dds_gra.bac)

dds_gra.fun <- DESeqDataSetFromMatrix(countData = counts.fun, colData = data.fun3, design = ~ gra1)
dds_gra.fun <- DESeq(dds_gra.fun)
res_gra.fun <- results(dds_gra.fun)

## legumes ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
dds_leg.bac <- DESeqDataSetFromMatrix(countData = counts.bac, colData = data.bac3, design = ~ leg1)
dds_leg.bac <- DESeq(dds_leg.bac)
res_leg.bac <- results(dds_leg.bac)

dds_leg.fun <- DESeqDataSetFromMatrix(countData = counts.fun, colData = data.fun3, design = ~ leg1)
dds_leg.fun <- DESeq(dds_leg.fun)
res_leg.fun <- results(dds_leg.fun)
```

**3.2 Filter the significant taxa**

After running DESeq2, we need to filter the taxa which are significantly differently abundant. To do so, we first wrote a function to merge our DESeq2 results with the taxonomy data for each of the 3 variables.

```{r function, tidy=TRUE, message=FALSE, warning=FALSE}
## PSR ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
res_psr.bac <- as.data.frame(res_psr.bac) # Convert res to data frame (if not already)
res_psr.bac$asv <- rownames(res_psr.bac) # Add a column for ASVs using rownames of res
taxa.bac$asv <- rownames(taxa.bac) # Add a column for ASVs using rownames of res
merged_res.psr.bac <- merge(res_psr.bac, taxa.bac, by.x = "asv", all.x = TRUE) 
# Merge the differential abundance results (res) with the taxonomic information (taxa.bac)
#merged_res.psr.bac <- merged_res.psr.bac[, -which(names(merged_res.psr.bac) == "row.names")] # Optional: remove the redundant 'row.names' column after merging

res_psr.fun <- as.data.frame(res_psr.fun) # Convert res to data frame (if not already)
res_psr.fun$asv <- rownames(res_psr.fun) # Add a column for ASVs using rownames of res
taxa.fun$asv <- rownames(taxa.fun) # Add a column for ASVs using rownames of res
merged_res.psr.fun <- merge(res_psr.fun, taxa.fun, by.x = "asv", all.x = TRUE) 
# Merge the differential abundance results (res) with the taxonomic information (taxa.bac)

## Grasses ~~~~~~~~~~~~~~~~~~~~~~~~~~~
res_gra.bac <- as.data.frame(res_gra.bac) # Convert res to data frame (if not already)
res_gra.bac$asv <- rownames(res_gra.bac) # Add a column for ASVs using rownames of res
taxa.bac$asv <- rownames(taxa.bac) # Add a column for ASVs using rownames of res
merged_res.gra.bac <- merge(res_gra.bac, taxa.bac, by.x = "asv", all.x = TRUE) 
# Merge the differential abundance results (res) with the taxonomic information (taxa.bac)

res_gra.fun <- as.data.frame(res_gra.fun) # Convert res to data frame (if not already)
res_gra.fun$asv <- rownames(res_gra.fun) # Add a column for ASVs using rownames of res
taxa.fun$asv <- rownames(taxa.fun) # Add a column for ASVs using rownames of res
merged_res.gra.fun <- merge(res_gra.fun, taxa.fun, by.x = "asv", all.x = TRUE) 
# Merge the differential abundance results (res) with the taxonomic information (taxa.bac)

## Legumes ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
res_leg.bac <- as.data.frame(res_leg.bac) # Convert res to data frame (if not already)
res_leg.bac$asv <- rownames(res_leg.bac) # Add a column for ASVs using rownames of res
taxa.bac$asv <- rownames(taxa.bac) # Add a column for ASVs using rownames of res
merged_res.leg.bac <- merge(res_leg.bac, taxa.bac, by.x = "asv", all.x = TRUE) 
# Merge the differential abundance results (res) with the taxonomic information (taxa.bac)

res_leg.fun <- as.data.frame(res_leg.fun) # Convert res to data frame (if not already)
res_leg.fun$asv <- rownames(res_leg.fun) # Add a column for ASVs using rownames of res
taxa.fun$asv <- rownames(taxa.fun) # Add a column for ASVs using rownames of res
merged_res.leg.fun <- merge(res_leg.fun, taxa.fun, by.x = "asv", all.x = TRUE) 
# Merge the differential abundance results (res) with the taxonomic information (taxa.bac)
```

```{r function2, tidy=TRUE, message=FALSE, warning=FALSE}
res_psr.bac2 <- merged_res.psr.bac
res_gra.bac2 <- merged_res.gra.bac
res_leg.bac2 <- merged_res.leg.bac

res_psr.fun2 <- merged_res.psr.fun
res_gra.fun2 <- merged_res.gra.fun
res_leg.fun2 <- merged_res.leg.fun
```

Then, we filtered for the significant taxa only, applying a *p* value filter of \< 0.05.

```{r filter, tidy=TRUE, message=FALSE, warning=FALSE}
res_psr_sig.bac <- merged_res.psr.bac[merged_res.psr.bac$pvalue < 0.05, ]
res_gra_sig.bac <- merged_res.gra.bac[merged_res.gra.bac$pvalue < 0.05, ]
res_leg_sig.bac <- merged_res.leg.bac[merged_res.leg.bac$pvalue < 0.05, ]

res_psr_sig.fun <- merged_res.psr.fun[merged_res.psr.fun$pvalue < 0.05, ]
res_gra_sig.fun <- merged_res.gra.fun[merged_res.gra.fun$pvalue < 0.05, ]
res_leg_sig.fun <- merged_res.leg.fun[merged_res.leg.fun$pvalue < 0.05, ]
```

Lastly, we create a new column which assigns to each ASVs whether it is 'significant' or not, and orders them based on significance.

```{r signif, tidy=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)

# add significance column 
res_psr.bac2$Significance <- ifelse(res_psr.bac2$pvalue < 0.05, "Significant", "Not Significant")
res_gra.bac2$Significance <- ifelse(res_gra.bac2$pvalue < 0.05, "Significant", "Not Significant")
res_leg.bac2$Significance <- ifelse(res_leg.bac2$pvalue < 0.05, "Significant", "Not Significant")

res_psr.fun2$Significance <- ifelse(res_psr.fun2$pvalue < 0.05, "Significant", "Not Significant")
res_gra.fun2$Significance <- ifelse(res_gra.fun2$pvalue < 0.05, "Significant", "Not Significant")
res_leg.fun2$Significance <- ifelse(res_leg.fun2$pvalue < 0.05, "Significant", "Not Significant")

# Step 1: Summarize significant taxa by Phylum
signif.taxa_psr.bac <-res_psr.bac2 %>% filter(Significance == "Significant")
signif.taxa_gra.bac <-res_gra.bac2 %>% filter(Significance == "Significant")
signif.taxa_leg.bac <-res_leg.bac2 %>% filter(Significance == "Significant")
signif.taxa_psr.fun <-res_psr.fun2 %>% filter(Significance == "Significant")
signif.taxa_gra.fun <-res_gra.fun2 %>% filter(Significance == "Significant")
signif.taxa_leg.fun <-res_leg.fun2 %>% filter(Significance == "Significant")

signif.phyla_psr.bac <- signif.taxa_psr.bac %>%  as.data.frame() %>%                        
  filter(Significance == "Significant") %>%       # Filter for significant taxa
  filter(!is.na(Phylum)) %>%                      # Remove rows with NA in Phylum
  mutate(Phylum = as.character(Phylum)) %>%       # Ensure Phylum is character
  dplyr::count(Phylum, name = "SignifCount") %>%  # Count significant taxa per Phylum
  dplyr::arrange(desc(SignifCount))   
signif.phyla_gra.bac <- signif.taxa_gra.bac %>%  
  as.data.frame() %>% 
  filter(Significance == "Significant") %>% 
  filter(!is.na(Phylum)) %>% 
  mutate(Phylum = as.character(Phylum)) %>% 
  dplyr::count(Phylum, name = "SignifCount") %>% 
  dplyr::arrange(desc(SignifCount))   
signif.phyla_leg.bac <- signif.taxa_leg.bac %>%  
  as.data.frame() %>% 
  filter(Significance == "Significant") %>% 
  filter(!is.na(Phylum)) %>% 
  mutate(Phylum = as.character(Phylum)) %>% 
  dplyr::count(Phylum, name = "SignifCount") %>% 
  dplyr::arrange(desc(SignifCount))   
signif.phyla_psr.fun <- signif.taxa_psr.fun %>%  
  as.data.frame() %>% 
  filter(Significance == "Significant") %>% 
  filter(!is.na(Phylum)) %>% 
  mutate(Phylum = as.character(Phylum)) %>% 
  dplyr::count(Phylum, name = "SignifCount") %>% 
  dplyr::arrange(desc(SignifCount))   
signif.phyla_gra.fun <- signif.taxa_gra.fun %>%  
  as.data.frame() %>% 
  filter(Significance == "Significant") %>% 
  filter(!is.na(Phylum)) %>% 
  mutate(Phylum = as.character(Phylum)) %>% 
  dplyr::count(Phylum, name = "SignifCount") %>% 
  dplyr::arrange(desc(SignifCount))   
signif.phyla_leg.fun <- signif.taxa_leg.fun %>%  
  as.data.frame() %>% 
  filter(Significance == "Significant") %>%
  filter(!is.na(Phylum)) %>% 
  mutate(Phylum = as.character(Phylum)) %>% 
  dplyr::count(Phylum, name = "SignifCount") %>% 
  dplyr::arrange(desc(SignifCount))   

# Step 2: Create an Ordered Factor for Phylum
res_psr.bac3 <- res_psr.bac2 %>% 
  mutate(Phylum = factor(Phylum, levels = signif.phyla_psr.bac$Phylum))
res_psr.fun3 <- res_psr.fun2 %>% 
  mutate(Phylum = factor(Phylum, levels = signif.phyla_psr.fun$Phylum))
res_gra.bac3 <- res_gra.bac2 %>% 
  mutate(Phylum = factor(Phylum, levels = signif.phyla_gra.bac$Phylum))
res_gra.fun3 <- res_gra.fun2 %>% 
  mutate(Phylum = factor(Phylum, levels = signif.phyla_gra.fun$Phylum))
res_leg.bac3 <- res_leg.bac2 %>% 
  mutate(Phylum = factor(Phylum, levels = signif.phyla_leg.bac$Phylum))
res_leg.fun3 <- res_leg.fun2 %>% 
  mutate(Phylum = factor(Phylum, levels = signif.phyla_leg.fun$Phylum))
```

### 4. Plot differential abundance testing results

```{r plot, tidy=FALSE, message=FALSE, warning=FALSE, fig.show='hide'}
library(ggplot2)
library(dplyr)
library(ggpubr)

## PSR ~~~~~~~~~~~~~~~~~~~ 
diff.bac1 = res_psr.bac3 %>% ggplot(aes(x = Phylum, y = log2FoldChange)) + 
  geom_point(data = ~filter(.x, Significance == "Not Significant"), 
             size = 1, color = "grey", position = position_jitter(), alpha = 0.5) +
  geom_point(data = ~filter(.x, Significance == "Significant"), 
             size = 1, color = "red", position = position_jitter()) +
  labs(x = "Phylum",y = "Log2 Fold Change") + theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.grid.major = element_line(color = "black", linetype = 2))

diff.fun1 = res_psr.fun3 %>% ggplot(aes(x = Phylum, y = log2FoldChange)) + 
  geom_point(data = ~filter(.x, Significance == "Not Significant"), 
             size = 1, color = "grey", position = position_jitter(), alpha = 0.5) +
  geom_point(data = ~filter(.x, Significance == "Significant"), 
             size = 1, color = "red", position = position_jitter()) +
  labs(x = "Phylum",y = "Log2 Fold Change") + theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.grid.major = element_line(color = "black", linetype = 2))

## grasses ~~~~~~~~~~~~~~~
diff.bac2 = res_gra.bac3 %>% ggplot(aes(x = Phylum, y = log2FoldChange)) + 
  geom_point(data = ~filter(.x, Significance == "Not Significant"), 
             size = 1, color = "grey", position = position_jitter(), alpha = 0.5) +
  geom_point(data = ~filter(.x, Significance == "Significant"), 
             size = 1, color = "red", position = position_jitter()) +
  labs(x = "Phylum",y = "Log2 Fold Change") + theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.grid.major = element_line(color = "black", linetype = 2))

diff.fun2 = res_gra.fun3 %>% ggplot(aes(x = Phylum, y = log2FoldChange)) + 
  geom_point(data = ~filter(.x, Significance == "Not Significant"), 
             size = 1, color = "grey", position = position_jitter(), alpha = 0.5) +
  geom_point(data = ~filter(.x, Significance == "Significant"), 
             size = 1, color = "red", position = position_jitter()) +
  labs(x = "Phylum",y = "Log2 Fold Change") + theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.grid.major = element_line(color = "black", linetype = 2))

## legumes ~~~~~~~~~~~~~~~
diff.bac3 = res_leg.bac3 %>% ggplot(aes(x = Phylum, y = log2FoldChange)) + 
  geom_point(data = ~filter(.x, Significance == "Not Significant"), 
             size = 1, color = "grey", position = position_jitter(), alpha = 0.5) +
  geom_point(data = ~filter(.x, Significance == "Significant"), 
             size = 1, color = "red", position = position_jitter()) +
  labs(x = "Phylum",y = "Log2 Fold Change") + theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.grid.major = element_line(color = "black", linetype = 2))

diff.fun3 = res_leg.fun3 %>% ggplot(aes(x = Phylum, y = log2FoldChange)) + 
  geom_point(data = ~filter(.x, Significance == "Not Significant"), 
             size = 1, color = "grey", position = position_jitter(), alpha = 0.5) +
  geom_point(data = ~filter(.x, Significance == "Significant"), 
             size = 1, color = "red", position = position_jitter()) +
  labs(x = "Phylum",y = "Log2 Fold Change") + theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        panel.grid.major = element_line(color = "black", linetype = 2))

ggpubr::ggarrange(
  ncol = 2, nrow = 3, diff.bac1, diff.fun1, diff.bac2, diff.fun2,
  diff.bac3, diff.fun3, common.legend = T, 
  labels = c("A: PSR", "","B: Has grass","","C: Has legumes",""), align = "hv")
```

### 5. Extract significantly up-/down-regulated ASV counts

To do so, we simply write a custom function using the `devtools` package.

```{r counts, tidy=FALSE, message=FALSE, warning=FALSE, results='hide'}
if (!require("devtools", quietly = TRUE)){
  install.packages("devtools")}

# Define the function
count_signif_ASVs.df <- function(data) {
  if (!all(c("Significance", "log2FoldChange") %in% names(data))) {
    stop("The data frame must contain 'Significance' and 'log2FoldChange' columns.")
  }
  
  sig_data <- subset(data, Significance == "Significant")
  
  positive_count <- sum(sig_data$log2FoldChange > 0, na.rm = TRUE)
  negative_count <- sum(sig_data$log2FoldChange < 0, na.rm = TRUE)
  
   return(data.frame(
    direction = c("positive", "negative"),
    count = c(positive_count, -negative_count)
  ))
}

# Apply to data frames
count_psr.bac.df = count_signif_ASVs.df(res_psr.bac3)
count_psr.fun.df = count_signif_ASVs.df(res_psr.fun3)
count_gra.bac.df = count_signif_ASVs.df(res_gra.bac3)
count_gra.fun.df = count_signif_ASVs.df(res_gra.fun3)
count_leg.bac.df = count_signif_ASVs.df(res_leg.bac3)
count_leg.fun.df = count_signif_ASVs.df(res_leg.fun3)

# Add dataset column
count_psr.bac.df$dataset = "psr"
count_gra.bac.df$dataset = "gra"
count_leg.bac.df$dataset = "leg"

count_psr.fun.df$dataset = "psr"
count_gra.fun.df$dataset = "gra"
count_leg.fun.df$dataset = "leg"

# Merge count dfs
signif.counts_bac = rbind(count_psr.bac.df, count_gra.bac.df,count_leg.bac.df)
signif.counts_fun = rbind(count_psr.fun.df, count_gra.fun.df,count_leg.fun.df)
```

Output:

```{r count out, tidy=FALSE, message=FALSE, warning=FALSE}
print(signif.counts_bac)
print(signif.counts_fun)
```

Plot results as a diverging barplot:

```{r count plot, tidy=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)

# Define custom colors for bars
custom_colors <- c("positive" = "#88B04B",   # mellow sage green
                   "negative" = "#B22222")   # darker red (firebrick)

# Custom legend labels
custom_labels <- c("positive" = "Upregulated", 
                   "negative" = "Downregulated")

gg.count_bac = ggplot(
  signif.counts_bac, aes(x = dataset, y = count, fill = direction)) +
  geom_bar(stat = "identity", width = 0.5) +
  coord_flip() +
  scale_y_continuous(labels = abs) +  # Show positive number labels
  scale_fill_manual(values = custom_colors, labels = custom_labels, name = NULL) +  
  scale_x_discrete(labels = c("psr" = "PSR", "gra" = "Grasses", "leg" = "Legumes")) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "black") +
  labs(x = NULL, y = "ASV count", title = NULL) + ggpubr::theme_classic2() +
  scale_y_continuous(limits = c(-8, 8), breaks = seq(-8, 8, 2))

gg.count_fun = ggplot(
  signif.counts_fun, aes(x = dataset, y = count, fill = direction)) +
  geom_bar(stat = "identity", width = 0.5) +
  coord_flip() +
  scale_y_continuous(labels = abs) +  # Show positive number labels
  scale_fill_manual(values = custom_colors, labels = custom_labels, name = NULL) +  
  scale_x_discrete(labels = c("psr" = "PSR", "gra" = "Grasses", "leg" = "Legumes")) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "black") +
  labs(x = NULL, y = "ASV count", title = NULL) + ggpubr::theme_classic2() +
  scale_y_continuous(limits = c(-70, 70), breaks = c(-60,-40,-20,0,20,40,60))

# Combine the two plots 
ggpubr::ggarrange(
  gg.count_bac, gg.count_fun, ncol = 2, nrow = 1, 
  common.legend = T, align = "h", labels = c("A", "B"))
```

